/*
 * CATS Flight Software
 * Copyright (C) 2021 Control and Telemetry Systems
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

#include "lqr_controller.h"
#include "config/globals.h"

void eval_gains_polyfit(control_data_t *control_data);
void control_data_reset(control_data_t *control_data);
void eval_optimal_trajectory_polyfit(control_data_t *control_data);
void compute_reference_error(control_data_t *control_data);
void compute_integrated_error(control_data_t *control_data);

void control_init(control_data_t *control_data) {
    control_data_reset(control_data);

    control_data->sf_velocity = 0;
    control_data->sf_ref_altitude_AGL = 0;
    control_data->tracking_feedback = 0;

    control_data->lowerboundary_aw = 0;
    control_data->upperboundary_aw = 0;
    /* The coefficients are sorted in the following way: Gain 1, Gain 2, Gain 3, Optimal Trajectory*/
    const double coeff0[POLY_DEG + 1] = {
            -0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000868001509274695588003190560506144,
            0.000000000000000000000000000000000000000000000000000000000000000000000000000000000006734144053942240645165763223097866695,
            -0.000000000000000000000000000000000000000000000000000000000000000000000000000000017943967053724527790526120972453756926449,
            0.000000000000000000000000000000000000000000000000000000000000000000000000000011600941491935255106453433215669137342465324,
            0.000000000000000000000000000000000000000000000000000000000000000000000000024003842653456406415201075555759650350223677265,
            -0.000000000000000000000000000000000000000000000000000000000000000000000018111809768284050761098616789038040361039057944148,
            -0.000000000000000000000000000000000000000000000000000000000000000000048626795322807690622140144022438412562738932905020920,
            0.000000000000000000000000000000000000000000000000000000000000000007420489314715460137826453965576002362709190070801883230,
            0.000000000000000000000000000000000000000000000000000000000000094912489417915252510561501393729204256289219371483064906746,
            0.000000000000000000000000000000000000000000000000000000000052920131301064704984426808487039401202507286820178230977021240,
            -0.000000000000000000000000000000000000000000000000000000142328584943567111040099678669599125806190931530978604529693922433,
            -0.000000000000000000000000000000000000000000000000000206637043647508274878826573874873913387740240970744978496233572370358,
            0.000000000000000000000000000000000000000000000000130334867334591797705159920212787647558817394492967999556852539610786702,
            0.000000000000000000000000000000000000000000000490489866515998216867458404379428187117827265098035412660415750117880703074,
            0.000000000000000000000000000000000000000000026867380644656436850000702522289482657478939067887135595991052719132239096434,
            -0.000000000000000000000000000000000000000958336406527050599461484506529266000580916845814498770483885341489941271723386135,
            -0.000000000000000000000000000000000000380110572500376264930409844941662974846208384219693874197621108524730596015191124200,
            0.000000000000000000000000000000001846228870037127080708718400229324628612006979121258828532160962041221158639206452239598,
            0.000000000000000000000000000000701063223175594818444883139638145152049380684396387992241048156796428280836621271983333248,
            -0.000000000000000000000000003903941552353450564236090389613619312482757597027505055531398063059663437746049652332658297382,
            0.000000000000000000000000921341687636553511160316676520504205771478259592850755826738722497823430579444448085268959403038,
            0.000000000000000000006947147284172662813389137056975705843499706683819221137788160747028598507313290610909461975097656250,
            -0.000000000000000011979567065868153518301726372320952852497657147544385392023968961439095437526702880859375000000000000000,
            0.000000000000010700672963404348022988568119097284740871703703768424986719765001907944679260253906250000000000000000000000,
            -0.000000000006235098773362018059773535637897243634301946979547892624395899474620819091796875000000000000000000000000000000,
            0.000000002525183589744375369531118971666051875590852660025120712816715240478515625000000000000000000000000000000000000000,
            -0.000000720864945346716686813465149036295187556788732763379812240600585937500000000000000000000000000000000000000000000000,
            0.000142835180023407189121506521978233195113716647028923034667968750000000000000000000000000000000000000000000000000000000,
            -0.018733383728017274222343857559280877467244863510131835937500000000000000000000000000000000000000000000000000000000000000,
            1.463511559528952288289360694761853665113449096679687500000000000000000000000000000000000000000000000000000000000000000000,
            -51.561961866915225982666015625000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000};
    const double coeff1[POLY_DEG + 1] = {
            -0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006929894392832814071182538693,
            0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000054425677379206007206037335008834,
            -0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000147580672324172961966870355106702292,
            0.000000000000000000000000000000000000000000000000000000000000000000000000000000000100331692340909445964638598038468649247,
            0.000000000000000000000000000000000000000000000000000000000000000000000000000000195868243086689447120388856000378948300240,
            -0.000000000000000000000000000000000000000000000000000000000000000000000000000161598364605904502187147276156491869346168962,
            -0.000000000000000000000000000000000000000000000000000000000000000000000000404072398506676206515067526538909826666120859871,
            0.000000000000000000000000000000000000000000000000000000000000000000000086490854091420275654937990622632139194420928381487,
            0.000000000000000000000000000000000000000000000000000000000000000000813047409216016282255984718926471005315495292041528582,
            0.000000000000000000000000000000000000000000000000000000000000000410718808596410661461492078666523948503802150600195847177,
            -0.000000000000000000000000000000000000000000000000000000000001265563730786173054911937688216365467163965080537859529660211,
            -0.000000000000000000000000000000000000000000000000000000001740635378171801234129210961440998689837149480322248674685895623,
            0.000000000000000000000000000000000000000000000000000001234711655204579968125016756495673589077811760936878899602008173981,
            0.000000000000000000000000000000000000000000000000004267072435751004784598937897887922322177137214767349212998926121809032,
            0.000000000000000000000000000000000000000000000000072737015794085804779462677452271279489733627755267979893677017158952050,
            -0.000000000000000000000000000000000000000000008465297853135322357500736794828702651673582632361307947220712812542503981252,
            -0.000000000000000000000000000000000000000003160441360587192413989116722111570882906058797872118951189497610818218780290818,
            0.000000000000000000000000000000000000016330368023997467734965921815608383294826089372673871764039991896698844445218994373,
            0.000000000000000000000000000000000006056752556505611966406346547023851785773461950640659821300210634902311926982865525445,
            -0.000000000000000000000000000000034304097738976319704134761135101278459396491181269269149574300715087513313245211592911188,
            0.000000000000000000000000000007851111829510705578820666495154013748892443112294765683215500413871004326292262973097102474,
            0.000000000000000000000000060834564747988713024506535044725518125570556422575707177802432965138448167641271879801934119314,
            -0.000000000000000000000103516827878680129991824792754095721355430168204110044884511251592207337068884953623637557029724121,
            0.000000000000000000091231816246328729567882113998767139710960376275921394255766228020831931644352152943611145019531250000,
            -0.000000000000000052429584971635806537466250536115653976870198260803665468721135312080150470137596130371093750000000000000,
            0.000000000000020955153485969207809806340873026377406661670613208237057278893189504742622375488281250000000000000000000000,
            -0.000000000005914117074991405656726923411466880615115770947198825524537824094295501708984375000000000000000000000000000000,
            0.000000001161718600379918641978872919208812253266671632445650175213813781738281250000000000000000000000000000000000000000,
            -0.000000151542782015878875821166026430231177357654814841225743293762207031250000000000000000000000000000000000000000000000,
            0.000011817032803199593347996503023278336286239209584891796112060546875000000000000000000000000000000000000000000000000000,
            -0.000730571100922361459963083607505041072727181017398834228515625000000000000000000000000000000000000000000000000000000000};
    const double coeff2[POLY_DEG + 1] = {
            -0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000043867245230357029103581055844633,
            0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000344490485188508716783274825893808887,
            -0.000000000000000000000000000000000000000000000000000000000000000000000000000000000934018022605933039216005802341479060134,
            0.000000000000000000000000000000000000000000000000000000000000000000000000000000634836548104500665275673422521919117185366,
            0.000000000000000000000000000000000000000000000000000000000000000000000000001239606407908012030174160563013339933812113437,
            -0.000000000000000000000000000000000000000000000000000000000000000000000001022381835686775337103413729710568651564362721281,
            -0.000000000000000000000000000000000000000000000000000000000000000000002556981976241690822393193246152569036255741229670767,
            0.000000000000000000000000000000000000000000000000000000000000000000546923120911685786160327644613604987256548299448649168,
            0.000000000000000000000000000000000000000000000000000000000000005144395586465708263248864187536114495172630520704805496922,
            0.000000000000000000000000000000000000000000000000000000000002598957900626994707360105955074991240578447205580992140764591,
            -0.000000000000000000000000000000000000000000000000000000008007265198030915847867088324688936778103519504737222019995215541,
            -0.000000000000000000000000000000000000000000000000000011012596304547960875754063524467217261978623179507934965030092573136,
            0.000000000000000000000000000000000000000000000000007813424460355518230137224758134701878337662411549720366986823781291171,
            0.000000000000000000000000000000000000000000000026996785758019778790415605805228291744047528796217135257388883945860792112,
            0.000000000000000000000000000000000000000000000453122545821515609722791732162586456301180955021948760347794437576693762049,
            -0.000000000000000000000000000000000000000053563190137796305881289862751094969744386557726456685402293821110980208963886471,
            -0.000000000000000000000000000000000000019976318126433723065385984554453131826161185132290324502967619645553667284221885352,
            0.000000000000000000000000000000000103343166980282802940037853931717963151868718028719503570980165018475073893736139637379,
            0.000000000000000000000000000000038273453233300523929121401279433260370520484136762154399274416415522512795413584342930219,
            -0.000000000000000000000000000217101763955207932149619711634519595537333220210248378142003358845087634086679084788329419098,
            0.000000000000000000000000049810794839236377681158654986343728815733024177921737193721767596816998174835688928396848496050,
            0.000000000000000000000384963770908737199535755590603621468013595183838185176183411054240401938386639812961220741271972656,
            -0.000000000000000000655353546691688177119597678067537473324012543609835661218010471884554135613143444061279296875000000000,
            0.000000000000000577760672934951596605344964105868965680659371953603598015547504473943263292312622070312500000000000000000,
            -0.000000000000332123470617645369376961526212574756953752053156847523496253415942192077636718750000000000000000000000000000,
            0.000000000132776890182980785371730039812513627511814107151622010860592126846313476562500000000000000000000000000000000000,
            -0.000000037481161968261776657794048621397120513165646116249263286590576171875000000000000000000000000000000000000000000000,
            0.000007363662813423413138445849934754505738965235650539398193359375000000000000000000000000000000000000000000000000000000,
            -0.000960668634241035259042906790938332051155157387256622314453125000000000000000000000000000000000000000000000000000000000,
            0.074914650496394216694362455655209487304091453552246093750000000000000000000000000000000000000000000000000000000000000000,
            -2.626833640295080929405457936809398233890533447265625000000000000000000000000000000000000000000000000000000000000000000000};
    const double optimal_trajectory_coeff[POLY_DEG + 1] = {
            -0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000027411389134354999755,
            0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400333617478819978558437,
            -0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001103844605225330066444625961,
            -0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005913969172819209921976381380022,
            0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000006443616328137509647356263397232881,
            0.000000000000000000000000000000000000000000000000000000000000000000000000000000000121532087486964998852972942516821312321,
            0.000000000000000000000000000000000000000000000000000000000000000000000000000000318930149202620025275368127982054854287990,
            -0.000000000000000000000000000000000000000000000000000000000000000000000000001003440910028299975003969397866120240240893972,
            -0.000000000000000000000000000000000000000000000000000000000000000000000010395116149777200955411653549248120984104817838462,
            -0.000000000000000000000000000000000000000000000000000000000000000000026037212126643199626279846569038331263586685839195816,
            0.000000000000000000000000000000000000000000000000000000000000000091645767868291007522546974467169281325771042831043550757,
            0.000000000000000000000000000000000000000000000000000000000000937553147795057933170925875478098891225926845805373795268481,
            0.000000000000000000000000000000000000000000000000000000002210047604875960037665972810764755834559108157498844078270251949,
            -0.000000000000000000000000000000000000000000000000000010306478821986800247349167683414937896922922216013769694969581476529,
            -0.000000000000000000000000000000000000000000000000088349331819269806524939488444393323043496273847164481148771495120700006,
            -0.000000000000000000000000000000000000000000000104914551354329000618508600024352144702760934779215322916384090486428505115,
            0.000000000000000000000000000000000000000001591641886608000101106116863762914173822178975751819380790040258434410473787625,
            0.000000000000000000000000000000000000006773608443543689476481931423616625023365320626932283906792633284733766294917691911,
            -0.000000000000000000000000000000000021867612109305100774159930884263556626774643409835209843404827846621039872416575348847,
            -0.000000000000000000000000000000183784243708874992821425118555943555525784434460375801157035942754066875015501325444158831,
            0.000000000000000000000000000505228674315566966895432782754013568184236697697905880844519272107029351191742616578039815067,
            0.000000000000000000000003717249061099920062739800344471156863840497019793586838346265187674188901212346536340191960334778,
            -0.000000000000000000026063649844827199513645725809438176151255231251605591418721991070484023111930582672357559204101562500,
            0.000000000000000075878275917591297634163885467706885575457626371201347303951934009091928601264953613281250000000000000000,
            -0.000000000000129790572516121997113976848478129044186461099608109748260176274925470352172851562500000000000000000000000000,
            0.000000000140794200748009999768922915352889826956506169608474010601639747619628906250000000000000000000000000000000000000,
            -0.000000097634982930669802345309028768216563776149996556341648101806640625000000000000000000000000000000000000000000000000,
            0.000042034070734335202655651553271809461875818669795989990234375000000000000000000000000000000000000000000000000000000000,
            -0.010837816999641099180440306781747494824230670928955078125000000000000000000000000000000000000000000000000000000000000000,
            1.950410888256399966067533569002989679574966430664062500000000000000000000000000000000000000000000000000000000000000000000,
            17.263277103281399860179590177722275257110595703125000000000000000000000000000000000000000000000000000000000000000000000000};

    memcpy(control_data->poly_coeff[0], coeff0, sizeof(coeff0));
    memcpy(control_data->poly_coeff[1], coeff1, sizeof(coeff1));
    memcpy(control_data->poly_coeff[2], coeff2, sizeof(coeff2));
    memcpy(control_data->optimal_trajectory_coeff, optimal_trajectory_coeff, sizeof(optimal_trajectory_coeff));

    for (int i = 0; i < NUM_GAINS; i++) {
        control_data->gains[i] = 0;
    }
}

void compute_control_input(control_data_t *control_data, flight_fsm_e flight_phase,
                           estimation_output_t *estimation_data) {
    /* Transfer Data to control_data */
    control_data->sf_velocity = estimation_data->velocity;
    control_data->sf_ref_altitude_AGL = estimation_data->height;

    if (flight_phase == COASTING) {
        /* Compute reference velocity */
        eval_optimal_trajectory_polyfit(control_data);

        /* calculate gains */
        eval_gains_polyfit(control_data);

        /* Calculate Velocity Error */
        compute_reference_error(control_data);

        /* Calculate Control Input */
        control_data->control_input =
                (float)(-control_data->gains[0] * (double)control_data->reference_error -
                        control_data->gains[1] * (double)control_data->integrated_error -
                        control_data->gains[2] * (double)(control_data->control_input - OPT_TRAJ_CONTROL_INPUT) +
                        (double)control_data->control_input);

        /* Check that the control input is between 0 and 1 */
        control_data->control_input = fmaxf(0, fminf(control_data->control_input, 1));

        compute_integrated_error(control_data);

    } else {
        /* This part of the controller is accessed, if the controller should not be operational */
        /* Airbrakes need to be retracted to prevent entanglement with the parachutes */
        control_data_reset(control_data);
    }
}

/* Does the Polynomial Calculation of the reference velocity */
void eval_gains_polyfit(control_data_t *control_data) {
    /* For Speed */
    double x_placeholder = 0;

    /* Reset gains */
    for (int i = 0; i < NUM_GAINS; i++) {
        control_data->gains[i] = 0;
    }

    /* For loop */
    for (int i = 0; i < POLY_DEG + 1; ++i) {
        x_placeholder = pow((double)control_data->sf_ref_altitude_AGL, (double)(POLY_DEG - i));
        control_data->gains[0] += control_data->poly_coeff[0][i] * x_placeholder;
        control_data->gains[1] += control_data->poly_coeff[1][i] * x_placeholder;
        control_data->gains[2] += control_data->poly_coeff[2][i] * x_placeholder;
    }
}

void control_data_reset(control_data_t *control_data) {
    control_data->control_input = 0;
    control_data->reference_error = 0;
    control_data->integrated_error = 0;
}

void eval_optimal_trajectory_polyfit(control_data_t *control_data) {
    /* For Speed */
    double x_placeholder = 0;

    /* Reset ref_velocity_placeholder*/
    double ref_velocity_placeholder = 0;

    /* For loop */
    for (int i = 0; i < POLY_DEG + 1; ++i) {
        x_placeholder = pow((double)control_data->sf_ref_altitude_AGL, (double)(POLY_DEG - i));
        ref_velocity_placeholder += (control_data->optimal_trajectory_coeff[i] * x_placeholder);
    }

    control_data->ref_velocity = (float)ref_velocity_placeholder;
}

void compute_reference_error(control_data_t *control_data) {
    if (control_data->ref_velocity < 0) {
        control_data->reference_error = control_data->sf_velocity;
    } else {
        control_data->reference_error = control_data->sf_velocity - control_data->ref_velocity;
    }
}

void compute_integrated_error(control_data_t *control_data) {
    control_data->upperboundary_aw =
            fmaxf(M_AW * (CONTROL_DEACTIVATION_ALTITUDE_AGL - control_data->sf_ref_altitude_AGL), MIN_BOUNDARAY_AW);
    if (CONTROL_DEACTIVATION_ALTITUDE_AGL < control_data->sf_ref_altitude_AGL) {
        control_data->upperboundary_aw = 0;
    }
    control_data->lowerboundary_aw = -control_data->upperboundary_aw;

    /* Compute the integrated error */
    control_data->integrated_error =
            fmaxf(control_data->lowerboundary_aw,
                  fminf(control_data->integrated_error + control_data->reference_error / CONTROL_SAMPLING_FREQ,
                        control_data->upperboundary_aw));
}