/*
 * CATS Flight Software
 * Copyright (C) 2021 Control and Telemetry Systems
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

#include "lqr_controller.h"
#include "config/globals.h"

void eval_gains_polyfit(control_data_t *control_data);
void control_data_reset(control_data_t *control_data);
void eval_optimal_trajectory_polyfit(control_data_t *control_data);
void compute_reference_error(control_data_t *control_data);
void compute_integrated_error(control_data_t *control_data);

void control_init(control_data_t *control_data) {
    control_data_reset(control_data);

    control_data->sf_velocity = 0;
    control_data->sf_ref_altitude_AGL = 0;
    control_data->tracking_feedback = 0;

    control_data->lowerboundary_aw = 0;
    control_data->upperboundary_aw = 0;
    /* The coefficients are sorted in the following way: Gain 1, Gain 2, Gain 3, Optimal Trajectory*/
    const double coeff0[POLY_DEG + 1] = {-0.000000000000000000000000000000000000000000000000000000000000000000000000000000000057010867040943750209098466587290184029, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000309825135072716909694227400242654504400951, -0.000000000000000000000000000000000000000000000000000000000000000000000000000542637688462723236815503154265392230425929811, 0.000000000000000000000000000000000000000000000000000000000000000000000000120569260997036425322722199298561594568613597987, 0.000000000000000000000000000000000000000000000000000000000000000000000490340196308304214124853513420373426062807842274299, -0.000000000000000000000000000000000000000000000000000000000000000000021107261210516402059778149627598343671730181841546095, -0.000000000000000000000000000000000000000000000000000000000000000516276034310013396611910351906372595328417293674053325337, -0.000000000000000000000000000000000000000000000000000000000000254684290509222103611930882114846160131146522817314613480276, 0.000000000000000000000000000000000000000000000000000000000403361183279303044291791691925268232820238295589045018145918539, 0.000000000000000000000000000000000000000000000000000000552697168489977150077966406131084594237911357107463830405809842827, -0.000000000000000000000000000000000000000000000000000065517557645768726645128161693337428679795047368083711017726273074959, -0.000000000000000000000000000000000000000000000000670785002747961429152345508956089745543030274508608375985612974620209277, -0.000000000000000000000000000000000000000000000387331686280229566115213914546058296299293807387668415902903739061103547032, 0.000000000000000000000000000000000000000000515157325102749521078722283634066952227021848855868785652279701332784495389812, 0.000000000000000000000000000000000000000760798605425729633188552343576278343954448178352038867224325373588089828271000350, -0.000000000000000000000000000000000000184138130342940501175690696941032959864521204051219235719089734531163235642473419286, -0.000000000000000000000000000000000970329460170698495092078843905716748627815641241246642775157842065036439265223712437227, -0.000000000000000000000000000000125081133287490447048295265416092735095885270359435192382940525447821266804017382133495939, 0.000000000000000000000000001109446635793776219295865729075944813742427031796916531041940882869445265425378810419942965382, 0.000000000000000000000000209447372913955823271139177000896990509543008638143791941956839452228938958100457057298626750708, -0.000000000000000000001334944813437333319542691133786423666178466303026253756184270338192021654322161339223384857177734375, 0.000000000000000000271096042350195994237939944021156397876716145094701184044272412876352973398752510547637939453125000000, 0.000000000000001384672738398997105074849334783959945778896816030723027068916053394787013530731201171875000000000000000000, -0.000000000001805674226283271699660258329548029668232267397343093762174248695373535156250000000000000000000000000000000000, 0.000000001191329539983891359041784640268937800477999644499504938721656799316406250000000000000000000000000000000000000000, -0.000000501845652083721385910692995568904706260582315735518932342529296875000000000000000000000000000000000000000000000000, 0.000143039570983609647288059552039385380339808762073516845703125000000000000000000000000000000000000000000000000000000000, -0.027656298097420064369122982839144242461770772933959960937500000000000000000000000000000000000000000000000000000000000000, 3.490866685479692144156160793500021100044250488281250000000000000000000000000000000000000000000000000000000000000000000000, -260.244402309012514251662651076912879943847656250000000000000000000000000000000000000000000000000000000000000000000000000000, 8704.443918067216145573183894157409667968750000000000000000000000000000000000000000000000000000000000000000000000000000000000};

    const double coeff1[POLY_DEG + 1] = {-0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000027111935312309316605646662406217749, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000000144231714250394459976529778648079725153, -0.000000000000000000000000000000000000000000000000000000000000000000000000000000244600836129391948226965927595077195717437, 0.000000000000000000000000000000000000000000000000000000000000000000000000000043628402626702638058980583724580343552007651, 0.000000000000000000000000000000000000000000000000000000000000000000000000220654996693921783608338824999838340641884641170, 0.000000000000000000000000000000000000000000000000000000000000000000000005365929613659770205420756230784521822758933623347, -0.000000000000000000000000000000000000000000000000000000000000000000223240450462677245837844870027551443738325005127099427, -0.000000000000000000000000000000000000000000000000000000000000000127514196966477292311383659578652600748266010119932498535, 0.000000000000000000000000000000000000000000000000000000000000159347474603251933530641715357332316013333678174451820676705, 0.000000000000000000000000000000000000000000000000000000000246636651167454918797856402457819963982483505882489234077109504, -0.000000000000000000000000000000000000000000000000000000002886151169121558535270750166282754660505649433100917504314262609, -0.000000000000000000000000000000000000000000000000000276401074517293851250813845611775467073525522422077314006881385274826, -0.000000000000000000000000000000000000000000000000186771807452858449872975563813232136582798466233852973901052064423514611, 0.000000000000000000000000000000000000000000000189604407090587317542927273886935663298096040669279636323887739202885809162, 0.000000000000000000000000000000000000000000326514124330754656631450927625341384064989191159548991604495409928448196675081, -0.000000000000000000000000000000000000000040484001254406955931202039233868843230876825274854102186907506292941246695859000, -0.000000000000000000000000000000000000391701384228972844901454307818837231554756326152627798011058888496454080820972961397, -0.000000000000000000000000000000000087647645100130420492088676154116858763239521961956746771874616917466459672060188039336, 0.000000000000000000000000000000432228915250940357729787927076554524724376637498384536367288778176174545988749448738319714, 0.000000000000000000000000000120723077668760804307519877605623452660557380866763099941948318036570578421808053182218145594, -0.000000000000000000000000518001614615525052551301548620121899486810384859026455094244829858388806664848402760981116443872, 0.000000000000000000000068244076568770151857589735808987860824352820609957752236933003348040571722776803653687238693237305, 0.000000000000000000551447684380142589047695530754504196125967634768059956115737740844906511483713984489440917968750000000, -0.000000000000000680006490682334825241038215069197602619958042350495341921146064123604446649551391601562500000000000000000, 0.000000000000435345809025020420107971026650603743027214548311221165022288914769887924194335937500000000000000000000000000, -0.000000000179374135837147944291510123447348865749484403409041988197714090347290039062500000000000000000000000000000000000, 0.000000050233692934639109373789707998353426532389676140155643224716186523437500000000000000000000000000000000000000000000, -0.000009574447598884519499231639250158565346282557584345340728759765625000000000000000000000000000000000000000000000000000, 0.001194488671303175651369765652987098292214795947074890136718750000000000000000000000000000000000000000000000000000000000, -0.088201188737953101215438778126554097980260848999023437500000000000000000000000000000000000000000000000000000000000000000, 2.897371493178070522844791412353515625000000000000000000000000000000000000000000000000000000000000000000000000000000000000};

    const double coeff2[POLY_DEG + 1] = {-0.000000000000000000000000000000000000000000000000000000000000000000000000000000000001726336475209686319633661270950469880, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000009198361300333964029425988619567796186284, -0.000000000000000000000000000000000000000000000000000000000000000000000000000015637602649320375879413408015223525500399298, 0.000000000000000000000000000000000000000000000000000000000000000000000000002842092085753014575831895089390520312587460244, 0.000000000000000000000000000000000000000000000000000000000000000000000014108503334852729045969385660395738507465785390071, 0.000000000000000000000000000000000000000000000000000000000000000000000269581826974505684142222676582559590567716049002533, -0.000000000000000000000000000000000000000000000000000000000000000014318720683758473280427613651532800310080507939995415655, -0.000000000000000000000000000000000000000000000000000000000000008089249284341396250371262181178161345598038005099036021720, 0.000000000000000000000000000000000000000000000000000000000010298238933143405581218181402333678646951583754035764933050266, 0.000000000000000000000000000000000000000000000000000000015779951105361393824630458861100114512793365014136742904791636820, -0.000000000000000000000000000000000000000000000000000000316299146850531052319183875725554045938579414071557039543402836435, -0.000000000000000000000000000000000000000000000000017798895436971970254902243150208314636431725724580423103352018461856118, -0.000000000000000000000000000000000000000000000011880175298218716456797959133205050920439298715531870940599435854654614815, 0.000000000000000000000000000000000000000000012332389042008210220654667451462018882579083810349224502737435969339478778208, 0.000000000000000000000000000000000000000020955626212743745892052035901833069892568490351558116723907219195970962772086550, -0.000000000000000000000000000000000000002798555829171882084580984669210586620867614304817717366370840148710409515619726022, -0.000000000000000000000000000000000025268088597386146903573855126521442916094146014124794217973836586342015996271591748939, -0.000000000000000000000000000000005448969018401101011294732910354300733034737208527302214253660511867850548952046870225183, 0.000000000000000000000000000027968891341255497224090200065170457510560334641303820870782491261765027829944499360159682055, 0.000000000000000000000000007588547828794857158808331357133841208790235958225695140250775653535664222459899974637664854527, -0.000000000000000000000033530947515042618214972656443822837258013526606339843038461368939645579345665282744448632001876831, 0.000000000000000000004628339716636176994768422789751202789851073841439723209763811018202517288955277763307094573974609375, 0.000000000000000035615139134631462860177125390532976126944516654044062264894421332428464666008949279785156250000000000000, -0.000000000000044133933113378278572848184153932279029776495488102128206264751497656106948852539062500000000000000000000000, 0.000000000028331427543114033990350236472215682010517001643279400013852864503860473632812500000000000000000000000000000000, -0.000000011696599957356978593358495268055702309695220719731878489255905151367187500000000000000000000000000000000000000000, 0.000003280768466428342188526872183484961453814321430400013923645019531250000000000000000000000000000000000000000000000000, -0.000626083601894847916261022113815215561771765351295471191406250000000000000000000000000000000000000000000000000000000000, 0.078184265366303296040939585509477183222770690917968750000000000000000000000000000000000000000000000000000000000000000000, -5.777400500308510267188921716297045350074768066406250000000000000000000000000000000000000000000000000000000000000000000000, 191.954219293408101520981290377676486968994140625000000000000000000000000000000000000000000000000000000000000000000000000000};

    const double optimal_trajectory_coeff[POLY_DEG + 1] = {-0.000000000000000000000000000000000000000000000000000000000000000000000000000000000409732881120523975318674456388878728131, 0.000000000000000000000000000000000000000000000000000000000000000000000000000002013735887572890035755033349306799002697809, -0.000000000000000000000000000000000000000000000000000000000000000000000000002918040289099760172387538344676599386861726683, -0.000000000000000000000000000000000000000000000000000000000000000000000000315855732499940018835799863318590810099531777171, 0.000000000000000000000000000000000000000000000000000000000000000000002832865075123860066706673454358803376572024603782197, 0.000000000000000000000000000000000000000000000000000000000000000001303547044694290049249086149223197028566505460082205132, -0.000000000000000000000000000000000000000000000000000000000000002401401373385540072458710170242679192800540530715120867637, -0.000000000000000000000000000000000000000000000000000000000003024528623374689907796964985983931792468900985001957687892997, 0.000000000000000000000000000000000000000000000000000000000600293710513091999336280311654286684373296521533400855541380119, 0.000000000000000000000000000000000000000000000000000004025039999106250134816266767294990945384294733900518115767814745409, 0.000000000000000000000000000000000000000000000000002378710028349860148102681238542479513355701051655630913327445833553368, -0.000000000000000000000000000000000000000000000003109468394751950215179963627580746327697229809937329724887234191038980146, -0.000000000000000000000000000000000000000000005207265116142080069360978702452496201474081251118567268257092638538231233963, 0.000000000000000000000000000000000000000000415115373950725026781926815988088789776561255937116602989436423068393621471930, 0.000000000000000000000000000000000000006889965598171180031017428830597033819986770003976616232739318504014744046449901682, 0.000000000000000000000000000000000002812039476856360158624828941068801212183746269359614923618999622776948424485255307467, -0.000000000000000000000000000000008079232838616429327239120474325072779365055570212277847629015481254265721821109140303972, -0.000000000000000000000000000005111618749195689878756171968801685676067016500382610826110954986816916945473730261861877722, 0.000000000000000000000000011303872131135900522307676729980971034176873039935694729984559490282346270323410308833445014898, 0.000000000000000000000002968849673289849946637269721930354963321599894904680180097680157816353307964618579717352986335754, -0.000000000000000000018246225524519699846693264206435971144351935647934909948825188408250141947064548730850219726562500000, 0.000000000000000019137518666545099582134403847770143011189399113634000693107140023130341432988643646240234375000000000000, -0.000000000000011164775896233599289392351096701272513504461618427665570152385043911635875701904296875000000000000000000000, 0.000000000004216298979614500083344276583047257190954570926777478234726004302501678466796875000000000000000000000000000000, -0.000000001076127404221229931118549456978052830669057016166334506124258041381835937500000000000000000000000000000000000000, 0.000000186388287419258991546613100399876206125782118760980665683746337890625000000000000000000000000000000000000000000000, -0.000021481655193598600799703701724752136215101927518844604492187500000000000000000000000000000000000000000000000000000000, 0.001583697556268320047814790463291956257307901978492736816406250000000000000000000000000000000000000000000000000000000000, -0.071424654748251603653130814564065076410770416259765625000000000000000000000000000000000000000000000000000000000000000000, 2.314212313872970216976909796358086168766021728515625000000000000000000000000000000000000000000000000000000000000000000000, 3.293402292750040150082213585847057402133941650390625000000000000000000000000000000000000000000000000000000000000000000000};

    memcpy(control_data->poly_coeff[0], coeff0, sizeof(coeff0));
    memcpy(control_data->poly_coeff[1], coeff1, sizeof(coeff1));
    memcpy(control_data->poly_coeff[2], coeff2, sizeof(coeff2));
    memcpy(control_data->optimal_trajectory_coeff, optimal_trajectory_coeff, sizeof(optimal_trajectory_coeff));

    for (int i = 0; i < NUM_GAINS; i++) {
        control_data->gains[i] = 0;
    }
}

void compute_control_input(control_data_t *control_data, flight_fsm_e flight_phase,
                           estimation_output_t *estimation_data) {
    /* Transfer Data to control_data */
    control_data->sf_velocity = estimation_data->velocity;
    control_data->sf_ref_altitude_AGL = estimation_data->height;

    if (flight_phase == COASTING) {
        /* Compute reference velocity */
        eval_optimal_trajectory_polyfit(control_data);

        /* calculate gains */
        eval_gains_polyfit(control_data);

        /* Calculate Velocity Error */
        compute_reference_error(control_data);

        /* Calculate Control Input */
        control_data->control_input =
                (float)(-control_data->gains[0] * (double)control_data->reference_error -
                        control_data->gains[1] * (double)control_data->integrated_error -
                        control_data->gains[2] * (double)(control_data->control_input - OPT_TRAJ_CONTROL_INPUT) +
                        (double)control_data->control_input);

        /* Check that the control input is between 0 and 1 */
        control_data->control_input = fmaxf(0, fminf(control_data->control_input, 1));

        compute_integrated_error(control_data);

    } else {
        /* This part of the controller is accessed, if the controller should not be operational */
        /* Airbrakes need to be retracted to prevent entanglement with the parachutes */
        control_data_reset(control_data);
    }
}

/* Does the Polynomial Calculation of the reference velocity */
void eval_gains_polyfit(control_data_t *control_data) {
    /* For Speed */
    double x_placeholder = 0;

    /* Reset gains */
    for (int i = 0; i < NUM_GAINS; i++) {
        control_data->gains[i] = 0;
    }

    /* For loop */
    for (int i = 0; i < POLY_DEG + 1; ++i) {
        x_placeholder = pow((double)control_data->sf_ref_altitude_AGL, (double)(POLY_DEG - i));
        control_data->gains[0] += control_data->poly_coeff[0][i] * x_placeholder;
        control_data->gains[1] += control_data->poly_coeff[1][i] * x_placeholder;
        control_data->gains[2] += control_data->poly_coeff[2][i] * x_placeholder;
    }
}

void control_data_reset(control_data_t *control_data) {
    control_data->control_input = 0;
    control_data->reference_error = 0;
    control_data->integrated_error = 0;
}

void eval_optimal_trajectory_polyfit(control_data_t *control_data) {
    /* For Speed */
    double x_placeholder = 0;

    /* Reset ref_velocity_placeholder*/
    double ref_velocity_placeholder = 0;

    /* For loop */
    for (int i = 0; i < POLY_DEG + 1; ++i) {
        x_placeholder = pow((double)control_data->sf_ref_altitude_AGL, (double)(POLY_DEG - i));
        ref_velocity_placeholder += (control_data->optimal_trajectory_coeff[i] * x_placeholder);
    }

    control_data->ref_velocity = (float)ref_velocity_placeholder;
}

void compute_reference_error(control_data_t *control_data) {
    if (control_data->ref_velocity < 0) {
        control_data->reference_error = control_data->sf_velocity;
    } else {
        control_data->reference_error = control_data->sf_velocity - control_data->ref_velocity;
    }
}

void compute_integrated_error(control_data_t *control_data) {
    control_data->upperboundary_aw =
            fmaxf(M_AW * (CONTROL_DEACTIVATION_ALTITUDE_AGL - control_data->sf_ref_altitude_AGL), MIN_BOUNDARAY_AW);
    if (CONTROL_DEACTIVATION_ALTITUDE_AGL < control_data->sf_ref_altitude_AGL) {
        control_data->upperboundary_aw = 0;
    }
    control_data->lowerboundary_aw = -control_data->upperboundary_aw;

    /* Compute the integrated error */
    control_data->integrated_error =
            fmaxf(control_data->lowerboundary_aw,
                  fminf(control_data->integrated_error + control_data->reference_error / CONTROL_SAMPLING_FREQ,
                        control_data->upperboundary_aw));
}